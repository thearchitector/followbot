# Start from a base Docker distribution (Ubuntu 18.04)
FROM ros:melodic-ros-base-bionic

ENV HOME /home/developer
WORKDIR /home/developer

RUN export uid=1000 gid=1000 && \
    mkdir -p /home/developer && \
    mkdir -p /etc/sudoers.d && \
    echo "developer:x:${uid}:${gid}:Developer,,,:/home/developer:/bin/bash" >> /etc/passwd && \
    echo "developer:x:${uid}:" >> /etc/group && \
    echo "developer ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/developer && \
    chmod 0440 /etc/sudoers.d/developer && \
    chown ${uid}:${gid} -R /home/developer && \
    apt-get update && \
    apt-get -y --no-install-recommends upgrade && \
    # Install a whole bunch of dependencies
    apt-get -y --no-install-recommends install build-essential cmake git libgtk-3-dev vim \
    pkg-config libavcodec-dev libavformat-dev libswscale-dev libtbb2 libtbb-dev curl sudo \
    ros-melodic-dwa-local-planner ros-melodic-cv-bridge ros-melodic-image-transport && \
    apt-get -y autoremove && \
    apt-get -y clean && \
    rm -rf /var/lib/apt/lists/*

# Add developer user to the dialout group to permiss writing to USB serial
RUN sed "s/^dialout.*/&developer/" /etc/group -i && \
    sed "s/^root.*/&developer/" /etc/group -i

# Download and install CLion
RUN curl -L "https://download.jetbrains.com/cpp/CLion-2019.2.5.tar.gz" -o /tmp/clion.tar.gz && \
    tar -xzf /tmp/clion.tar.gz --directory /etc && \
    ln -s /etc/clion-2019.2.5/bin/clion.sh /etc/clion-2019.2.5/bin/clion && \
    rm -rf /tmp/clion.tar.gz
ENV PATH="/etc/clion-2019.2.5/bin:${PATH}"

# Download and install Arduino IDE
RUN curl -L "https://downloads.arduino.cc/arduino-1.8.10-linux64.tar.xz" -o /tmp/arduinoide.tar.xz && \
    tar -xJf /tmp/arduinoide.tar.xz --directory /etc && \
    /etc/arduino-1.8.10/install.sh && \
    rm -rf /tmp/arduinoide.tar.xz

# Build and install OpenCV
RUN mkdir /tmp/opencv && \
    git clone https://github.com/opencv/opencv.git /tmp/opencv/core && \
    git clone https://github.com/opencv/opencv_contrib.git /tmp/opencv/contrib && \
    cd /tmp/opencv/core && \
    mkdir build && \
    cd build && \
    cmake -DCMAKE_BUILD_TYPE=RELEASE -DINSTALL_C_EXAMPLES=OFF -DWITH_TBB=ON -DWITH_V4L=ON \
          -DWITH_QT=OFF -DWITH_OPENGL=OFF -DOPENCV_EXTRA_MODULES_PATH=../../contrib/modules \
          -DBUILD_EXAMPLES=OFF -DBUILD_DOCS=OFF -DBUILD_opencv_java=OFF -DBUILD_opencv_python=OFF \
          -DBUILD_opencv_apps=OFF -DBUILD_openev_legacy=OFF -DBUILD_opencv_python2=OFF \
          -DBUILD_PERF_TESTS=OFF -DBUILD_TESTS=OFF -DWITH_OPENMP=ON -DWITH_IPP=ON -DWITH_CSTRIPES=ON \
          -DCMAKE_INSTALL_PREFIX=/usr/local -DCMAKE_CXX_FLAGS="-DTBB_USE_GCC_BUILTINS=1" \
          -DOPENCV_ENABLE_NONFREE=ON -DENABLE_CXX11=ON .. && \
    # Compile with max number of cores
    make -j$(nproc --ignore=1) && \
    make install && \
    rm -rf /tmp/*

# Setup bash entry point
COPY ./entrypoint.dev /ros_entrypoint.sh
RUN chmod +x /ros_entrypoint.sh
ENV DISPLAY :1.0

# Git clone the repo and update ROS dependencies
USER developer
RUN cd /home/developer && \
    git clone https://github.com/thearchitector/followbot.git

ENTRYPOINT ["/ros_entrypoint.sh"]
CMD ["bash"]
